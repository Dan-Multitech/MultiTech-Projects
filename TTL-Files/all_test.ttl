;
;
connect '192.168.2.1 /ssh /auth=password /user=mtadm /passwd=root /nosecuritywarning'

timeout = 10
clearscreen 1
show 0
radioVersion = '00.00.000'
isNONE = -1
isLAT1 = -1
isLAT3 = -1
isLEU1 = -1
isL4E1 = -1
isL4N1 = -1

:CHECK_MTCDT_TYPE
strcompare param2 '240L'
is240L = result
if is240L=0 goto CHECK_RADIO_TYPE
strcompare param2 '246L'
is246L = result
if is246L=0 goto CHECK_RADIO_TYPE
strcompare param2 '247L'
is247L = result
if is247L=0 goto CHECK_RADIO_TYPE

:CHECK_RADIO_TYPE
strcompare param3 'NONE'
isNONE = result
if isNONE=0 goto START
strcompare param3 'LAT1'
isLAT1 = result
if isLAT1=0 goto START
strcompare param3 'LAT3'
isLAT3 = result
if isLAT3=0 goto START
strcompare param3 'LEU1'
isLEU1 = result
if isLEU1=0 goto START
strcompare param3 'L4E1'
isL4E1 = result
if isL4E1=0 goto START
strcompare param3 'L4N1'
isL4N1 = result
if isL4N1=0 goto START


:START
if isLAT1=0 then 
    radioVersion = '17.00.503'
elseif isLEU1=0 then
    radioVersion = '17.00.523'
elseif isL4E1=0 then
	radioVersion = '25.20.673'
elseif isL4N1=0 then
	radioVersion = '25.20.666'
endif

wait '$'
sendln 'sudo -s'
wait 'word:'
sendln 'root'
wait '#'
mpause 500

:LED_TEST
statusbox 'Please do a visual check on LED!' 'CHECK LED'
bringupbox
for i 1 3
	mpause 300
	sendln 'mts-io-sysfs store led-a 1'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-b 1'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-c 1'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-d 1'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-a 0'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-b 0'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-c 0'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-d 0'
	wait "mtcdt:/home/mtadm#"
	mpause 500
next
closesbox
timeout = 3
mpause 500
wait "No such file"
if result=1 then
   goto LED_FAILURE
endif
mpause 500

timeout = 10
:TEMPERATURE_TEST
flushrecv
sendln 'cat /sys/class/hwmon/hwmon0/device/temp1_input'
waitln '4' '3'
str2int strvar inputstr
statusbox strvar 'temp'
pause 2 
closesbox
if strvar > 45000 then
	messagebox 'TEMP VALUE HIGH LIMIT FAILURE!' 'TEMP FAILURE'
	messagebox strvar 'Temperature Value'
	disconnect
	end
endif
wait "mtcdt:/home/mtadm#"
mpause 1000

:LORA_TEST
flushrecv
sendln 'mts-io-sysfs show ap1/*'
wait "MTAC"
if result=1 then
    statusbox 'MTAC1 PASSED' 'PASSED1'
	mpause 1000
	closesbox
else
	beep
	messagebox 'MTCDT LORA AP1 READ FAILURE!' 'LORA AP1 FAILURE'
	end
	disconnect
endif
mpause 1000
flushrecv
sendln 'mts-io-sysfs show ap2/*'
wait "MTAC"
if result=1 then
	statusbox 'MTAC2 PASSED' 'PASSED2'
	mpause 1000
	closesbox
else
	beep
	messagebox 'MTCDT LORA AP2 READ FAILURE!' 'LORA AP2 FAILURE'
	end
	disconnect
endif
mpause 1000

:THUMB_DRIVE_TEST
mpause 1000
flushrecv
sendln 'df'
wait "/dev/sda1" "/dev/sdb1"
if result=0 then
  beep
  messagebox 'THUMB DRIVE NOT DETECTED' 'THUMB DRIVE FAILURE'
  disconnect
  closett
  end
endif
mpause 500

if isNONE=0 goto SHORTING_MTCDT

:SIM_TEST
sendln 'microcom /dev/modem_at0'
mpause 500
sendln 'at+cpin?'
wait 'OK' 'not found' 'ERROR'
if result=1 then
    statusbox 'SIM CHECK PASSED' 'PASSED'
	mpause 1000
	closesbox
else
  beep
  messagebox 'SIM TEST FAILURE!' 'SIM FAILURE'
  disconnect
  closett
  end
endif
mpause 1000

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;SMC;;;;;;;;;;;;;;;;;;;;
:SMC_TEST
flushrecv
sendln 'at+gmi'
wait "OK"
mpause 1000
sendln 'at+gmm'
wait "OK"
mpause 1000
sendln 'at#swpkgv'
wait radioVersion ;Check radio version
if result=1 then
  mpause 1000
else
  beep
  messagebox 'WRONG RADIO VERSION!' 'SMC FAILURE'
  disconnect
  closett
  end
endif
mpause 1000

:CSQ_TEST
timeout = 3
pause 1
sendln 'AT+CSQ'
wait '99,99'
if result=1 goto CSQ_TEST
pause 2
sendln 'at+csq'
wait 'OK'
pause 2
sendln 'at+csq'
wait 'OK'
timeout = 30
mpause 500
sendln 'at+csq'
waitrecv '+CSQ: ' 10 1
strconcat rssi3 inputstr
strremove rssi3 1 6
strremove rssi3 3 2
str2int strvar rssi3
strtrim rssi3 ','
statusbox rssi3 'RSSI'
if strvar >= 7 then
  mpause 1000
  else
  beep
  messagebox 'CSQ SIGNAL STRENGTH FAILURE!' 'CSQ FAILURE'
  goto LOW_RSSI
endif
mpause 500
mpause 1000
closesbox
flushrecv
timeout=5
mpause 500
if isLAT3=0 then
   sendln 'at#gpio=1,0,2'
   waitln'OK'
endif
mpause 500
sendln 'at#sled=2'
waitln 'OK'
mpause 500
sendln 'at#sledsav'
wait 'OK'
mpause 500
if isLAT3=0 then
   sendln 'at#rxdiv=1,3'
   wait 'OK'
   mpause 1000
   sendln 'at#rxdiv?
   wait '#RXDIV: 1,3'
   if result=0 then
   	  beep
   	  messagebox 'DIVERSITY FAILURE! PLEASE RETEST' 'DIVERSITY FAILURE'
   	  disconnect
   	  closett
   	  end
	endif
endif
flushrecv
mpause 500
flushrecv
sendln 'at+cpin?'
wait "READY"
if result=1 then
  mpause 1000
else
  beep
  messagebox "**** SIM NOT DETECTED ****" "SIM FAILURE"
  end
  disconnect
endif
mpause 500

mpause 500
sendln 'at#servinfo'
waitln '#SERVINFO:'
	   if result=0 goto NETWORK_CONNECTION_FAILURE
strscan inputstr "-"
strcopy inputstr result 4 rssi_level
strtrim rssi_level ','
statusbox  rssi_level 'Signal Level'
str2int rssi rssi_level
		if rssi < -99 goto LOW_RSSI
mpause 1000
flushrecv
sendln 'at#moni'
waitln '#MONI:'
	   if result=0 goto NETWORK_CONNECTION_FAILURE
strscan inputstr  'PWR:'
result = result + 4
strcopy inputstr result 4 sig_level
strtrim sig_level 'd'
statusbox  sig_level 'Signal Level'
str2int rssi2 sig_level
		if rssi2 < -99 goto LOW_RSSI
mpause 1000
closesbox
mpause 500
flushrecv
sendln 'at#servinfo'
waitln 'T-Mobile' 'AT&T' 'Verizon'
	if result=0 goto NETWORK_CONNECTION_FAILURE
pause 1
sendln 'at#moni'
waitln 'T-Mobile' 'AT&T' 'Verizon'
	if result=0 goto NETWORK_CONNECTION_FAILURE
pause 1

:APN1_CHECK
sendln 'at+cgdcont?'
waitln '+CGDCONT: 1,"IPV4V6","","",0,0'
   if result =0 then
   sendln 'at+cgdcont=1,"IPV4V6",""'
   goto APN1_CHECK
endif
pause 1
sendln 'at+cgsn'
wait 'OK'
mpause 500
flushrecv
sendln 'at#cfvr'
wait '0' '2' '6'
if result > 0 then
   	mpause 1000
else
   	beep
  	messagebox "FIRMWARE SUB VERSION FAILURE" "FIRMWARE SUB FAILURE"
    disconnect
    closett
	end
endif

mpause 500
mpause 1000
flushrecv
sendln 'at+cgsn'
wait "OK"
mpause 1000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

:SHORTING_MTCDT
if is240L=0 goto TEST_DONE
if is246L=0 goto GPS_TEST
if is247L=0 goto GPS_TEST

timeout =60
:GPS_TEST
send 24 ;Quit 'at' command promt
wait '#'
flushrecv
sendln 'gpspipe -r'
wait '4505.' '4506.' 
if result=0 then 
   messagebox 'UNABLE TO GET GPS LOCATION' 'GPS TEST FAILURE'
   disconnect
   closett
   end
endif
send 3
wait '#'
pause 1
send 3
wait '#'
pause 1
timeout=2

:WIFI_BT_TEST


:TEST_DONE
beep
send 24
messagebox "MTCDT TEST COMPLETE" "TEST DONE"
disconnect
closett
end
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
:LED_FAILURE
messagebox 'FIX FAILING LEDs. RETEST!' 'LED FAILURE'
disconnect
closett
end

:NETWORK_CONNECTION_FAILURE
messagebox 'UNABLE TO FIND WIRELESS NETWORK. RETEST!' 'NETWORK CONNECTION FAILURE'
disconnect
closett
end

:LOW_RSSI
messagebox 'CSQ SIGNAL TOO LOW. RETEST!' 'WIRELESS SIGNAL MEASUREMENT FAILURE'
disconnect
closett
end
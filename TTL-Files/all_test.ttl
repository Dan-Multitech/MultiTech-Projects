;
;
connect '192.168.2.1 /ssh /auth=password /user=mtadm /passwd=root /nosecuritywarning'

timeout = 10
clearscreen 1
show 0
radioVersion = '00.00.000'
isNONE = -1
isLAT1 = -1
isLAT3 = -1
isLEU1 = -1
isL4E1 = -1
isL4N1 = -1

:CHECK_MTCDT_TYPE
strcompare param2 '240L'
is240L = result
if is240L=0 goto CHECK_RADIO_TYPE
strcompare param2 '246L'
is246L = result
if is246L=0 goto CHECK_RADIO_TYPE
strcompare param2 '247L'
is247L = result
if is247L=0 goto CHECK_RADIO_TYPE

:CHECK_RADIO_TYPE
strcompare param3 'NONE'
isNONE = result
if isNONE=0 goto START
strcompare param3 'LAT1'
isLAT1 = result
if isLAT1=0 goto START
strcompare param3 'LAT3'
isLAT3 = result
if isLAT3=0 goto START
strcompare param3 'LEU1'
isLEU1 = result
if isLEU1=0 goto START
strcompare param3 'L4E1'
isL4E1 = result
if isL4E1=0 goto START
strcompare param3 'L4N1'
isL4N1 = result
if isL4N1=0 goto START


:START
if isLAT1=0 then 
    radioVersion = '17.00.503'
elseif isLEU1=0 then
    radioVersion = '17.00.523'
elseif isL4E1=0 then
	radioVersion = '25.20.673'
elseif isL4N1=0 then
	radioVersion = '25.20.666'
endif

wait '$'
sendln 'sudo -s'
wait 'word:'
sendln 'root'
wait '#'
mpause 500

:LED_TEST
statusbox 'Please do a visual check on LED!' 'CHECK LED'
bringupbox
for i 1 3
	mpause 300
	sendln 'mts-io-sysfs store led-a 1'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-b 1'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-c 1'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-d 1'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-a 0'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-b 0'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-c 0'
	wait "mtcdt:/home/mtadm#"
	sendln 'mts-io-sysfs store led-d 0'
	wait "mtcdt:/home/mtadm#"
	mpause 500
next
closesbox
timeout = 3
mpause 500
wait "No such file"
if result=1 then
   goto LED_FAILURE
endif
mpause 500

timeout = 5
:TEMPERATURE_TEST
flushrecv
sendln 'cat /sys/class/hwmon/hwmon0/device/temp1_input'
waitln '4' '3'
str2int strvar inputstr
statusbox strvar 'temp'
pause 2 
closesbox
if strvar > 45000 then
	messagebox 'TEMP VALUE HIGH LIMIT FAILURE!' 'TEMP FAILURE'
	messagebox strvar 'Temperature Value'
	disconnect
	end
endif
wait "mtcdt:/home/mtadm#"
mpause 1000

:DRIVE_TEST
timeout = 2
flushrecv
wait '#'
sendln 'df'
wait '/dev/sda1' '/dev/sdb1'
if result=0 then
  beep
  messagebox 'THUMB DRIVE NOT DETECTED' 'THUMB DRIVE FAILURE'
  disconnect
  closett
  end
endif
mpause 500
wait '#'
sendln 'ls /media/card'
wait 'No such file' 'mmcblk0p1'
if result>1 then
   beep
   messagebox 'SD CARD NOT DETECTED' 'SD CARD FAILURE'
   disconnect
   closett
   end
endif

:read_write_sd_test
flushrecv
sendln 'cp /bin/bash /media/card/'
wait "#"
sendln 'ls /media/card'
waitln 'bash'
if result=0 then
    beep
    messagebox 'SD CARD READ-WRITE FAILED' 'SD CARD FAILURE'
    disconnect
    closett
    end
endif
mpause 500
wait '#'
sendln "md5sum /bin/bash |awk '{print $1}'"
strconcat cksum1 inputstr
pause 1
sendln "md5sum /media/card/bash |awk '{print $1}'"
strconcat cksum2 inputstr
pause 1
strcompare cksum1 cksum2
if result<>0 then
    messagebox 'SD READ-WRITE TEST FAILURE' 'SD CARD FAILURE'
    disconnect
    closett
    end
endif
mpause 1000
sendln 'rm /media/card/bash'
wait "#"

:read_write_thumbdrive_test
flushrecv
usbdrive=''
pause 1
sendln "df |grep sd |awk '{print $1}'"
waitln '/dev'
strconcat usbdrive inputstr
strremove usbdrive 1 5
mpause 1
sendln 'cp /bin/bash /media/'usbdrive
wait "#"
flushrecv
sendln 'ls /media/'usbdrive'
mpause 500
sendln "md5sum /bin/bash |awk '{print $1}'"
strconcat cksum3 inputstr
wait '#'
sendln "md5sum /media/"usbdrive"/bash |awk '{print $1}'"
strconcat cksum4 inputstr
pause 1
strcompare cksum3 cksum4
if result<>0 then
    messagebox 'THUMB DRIVE READ-WRITE TEST FAILURE' 'THUMB DRIVE FAILURE'
	disconnect
    closett
    end
endif
flushrecv
mpause 500
sendln 'rm /media/'usbdrive'/bash'
statusbox 'THUMB DRIVE AND SD CARD PASSED' 'PASSED'
mpause 500
closesbox
mpause 1000

:LORA_TEST
timeout = 5
flushrecv
sendln 'mts-io-sysfs show ap1/*'
wait "MTAC"
if result=1 then
    statusbox 'MTAC1 PASSED' 'PASSED1'
	mpause 1000
	closesbox
else
	beep
	messagebox 'MTCDT LORA AP1 READ FAILURE!' 'LORA AP1 FAILURE'
	end
	disconnect
endif
mpause 2000
flushrecv
sendln 'mts-io-sysfs show ap2/*'
wait "MTAC"
if result=1 then
	statusbox 'MTAC2 PASSED' 'PASSED2'
	mpause 1000
	closesbox
else
	beep
	messagebox 'MTCDT LORA AP2 READ FAILURE!' 'LORA AP2 FAILURE'
	end
	disconnect
endif
mpause 1000

if isNONE=0 goto SHORTING_MTCDT

:SIM_TEST
sendln 'microcom /dev/modem_at0'
mpause 500
sendln 'at+cpin?'
wait 'OK' 'not found' 'ERROR'
if result=1 then
    statusbox 'SIM CHECK PASSED' 'PASSED'
	mpause 1000
	closesbox
else
  beep
  messagebox 'SIM TEST FAILURE!' 'SIM FAILURE'
  disconnect
  closett
  end
endif
mpause 1000

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;SMC;;;;;;;;;;;;;;;;;;;;
:SMC_TEST
imei = ''
timeout = 2

mpause 500
wait '#'
sendln 'microcom /dev/modem_at0'
:init
mpause 500
sendln 'at'
waitln 'OK'
if result=0 goto init
mpause 500
sendln 'ate1'
wait 'OK'
mpause 500
sendln 'at+cgsn'
waitln 'ERROR' '35' '0'
if result = 1 then
    messagebox 'COULD NOT FIND IMEI. PLEASE REPORT!' 'IMEI CHECK FAILURE'
    disconnect
   	closett
   	end
endif
strconcat imei inputstr
mpause 500
sendln 'at+cgsn'
wait 'OK'
mpause 500
sendln 'at#gpio=1,0,2'
waitln'OK'
mpause 500
sendln 'at#sled=2'
waitln 'OK'
mpause 500
sendln 'at#sledsav'
wait 'OK'
:temp_setting
flushrecv
mpause 500
sendln 'at#tempcfg?'
waitln '#TEMPCFG: -273,-33,0,-35,-28,0,-30,97,0,95,102,2,100,528,3'
if result=0 goto temp_setting
mpause 500
sendln 'at#rxdiv?
wait '#RXDIV: 1,1'
if result = 0 then
    mpause 500
    sendln 'at#rxdiv=1,1'
endif
:apn1_check
flushrecv
mpause 500
sendln 'at+cgdcont?'
waitln '+CGDCONT: 1,"IPV4V6",""'
if result =0 then
    sendln 'at+cgdcont=1,"IPV4V6","",""'
    goto apn1_check
endif
mpause 500
sendln 'at+cgdcont?'
waitln '+CGDCONT: 2,"IPV4V6","ims"'
if result =0 then
    sendln 'at+cgdcont=2,"IPV4V6","ims"'
    goto apn1_check
endif
mpause 500
sendln 'at+cgdcont?'
waitln '+CGDCONT: 3,"IPV4V6","sos"'
if result =0 then
    sendln 'at+cgdcont=3,"IPV4V6","sos"'
    goto apn1_check
endif

if isL4E1 = 0 goto l4e1_test
if isL4N1 = 0 goto l4n1_test

:l4e1_test
mpause 500
sendln 'at+gmm'
waitln 'LE910C4-EU'
if result = 0 then
    messagebox 'INCORRECT TELIT MODULE. EXPECTED: LE910C4-EU' 'MODULE FAILURE'
   	disconnect
   	closett
   	end
endif
flushrecv
mpause 500
sendln 'at+gmr'
waitln '25.20.673'
if result = 0 then
    messagebox 'INCORRECT FIRMWARE VERSION. EXPECTED: 25.20.673' 'FIRMWARE FAILURE'
	disconnect
   	closett
   	end
endif
mpause 500 
flushrecv
sendln 'at#cfvr'
waitln '2'
if result=0 then
    messagebox 'INCORRECT TELIT FIRMWARE BUILD. EXPECTED: 2' 'FIRMWARE BUILD FAILURE'
	disconnect
   	closett
   	end
endif
send 24 ;Quit 'at' command promt
goto SHORTING_MTCDT

:l4n1_test
mpause 500
sendln 'at+gmm'
waitln 'LE910C4-NF'
;Still working on...........
send 24 ;Quit 'at' command promt
goto SHORTING_MTCDT
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

:SHORTING_MTCDT
if is240L=0 goto TEST_DONE
if is246L=0 goto GPS_TEST
if is247L=0 goto GPS_TEST

:GPS_TEST
timeout = 70
mpause 500
flushrecv
sendln 'gpspipe -r'
wait '4505.' '4506.' 
if result=0 then 
   messagebox 'UNABLE TO GET GPS LOCATION' 'GPS TEST FAILURE'
   disconnect
   closett
   end
endif
send 3
wait '#'
pause 1
statusbox 'GPS TEST PASSED' 'PASSED'
mpause 500
closesbox
pause 1

if is246L=0 goto TEST_DONE

:WIFI_BT_TEST
timeout = 10

:TEST_DONE
beep
messagebox 'MTCDT TEST COMPLETE' 'TEST DONE'
disconnect
closett
end


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
:LED_FAILURE
messagebox 'FIX FAILING LEDs. RETEST!' 'LED FAILURE'
disconnect
closett
end

:NETWORK_CONNECTION_FAILURE
messagebox 'UNABLE TO FIND WIRELESS NETWORK. RETEST!' 'NETWORK CONNECTION FAILURE'
disconnect
closett
end

:LOW_RSSI
messagebox 'CSQ SIGNAL TOO LOW. RETEST!' 'WIRELESS SIGNAL MEASUREMENT FAILURE'
disconnect
closett
end
;
;	Author: 		Viet Ho
;	Description: 	Teraterm Script For Functional Test of XDOTs-ALL Freq.
;					Cannot Stand-alone run!
;					Only work with other program that passes PARAMETERS to this macro.
;

show 0
timeout = 3
mpause 1000

strcompare param8 'newTTVersion'
isTTNewVersion = result
if isTTNewVersion = 0 then
    sprintf2 cmdStr '/C=%s' param3
    connect cmdStr
endif

:GET_SET_VARS
firmwareVers = '3.0.2-debug-mbed144'
xdotMainPort = param3	;101
xdotBreakPort = param4	;11
xdotPortName = param5 	;PORT1
;sprintf2 xdotDriveLoc 'C:\DRIVES\%s' param6
sprintf2 xdotDriveLoc '%s:\' param6
strcompare param7 'singleTest'
isSingleTest = result
testStatus = ''
fail = 0
pingLevel = ''
rssiLevel = ''
sprintf2 portNumberFailureMsg 'PORT %s FAILURE' xdotMainPort

:CHECK_CONNECTION
mpause 300
sendln 'at'
waitln 'OK'
if result=1 then
    if isSingleTest = 0 then
        statusbox 'CONNECTED SUCCESSFULLY' 'PASSED1'
    	mpause 300
		closesbox
	endif 
endif
if result=0 then
    closett
    sprintf2 msg1 'COM PORT %s is not responding!' xdotMainPort
    statusbox msg1 portNumberFailureMsg
    testStatus = 'CONNECTION FAILED'
    mpause 300
    closesbox
    ;goto WRITE_RESULT_DATA
    end
endif

:CHECK_DRIVE
sprintf2 cmdStr '%sDETAILS.TXT' xdotDriveLoc
filesearch cmdStr
if result = 0 then
    sprintf2 msg1 'Location %s is NOT FOUND!' xdotDriveLoc
    statusbox msg1 portNumberFailureMsg
    mpause 300
    closett
    end
endif

:CHECK_CURRENT_PROGRAM
mpause 300
sendln 'ati'
waitln firmwareVers 'OK'
if result=1 then
    if isSingleTest = 0 then
        statusbox 'PROGRAM PASSED' 'PASSED2'
    	mpause 300
		closesbox
	endif
	sprintf2 msg1 'PORT %s PASSED' xdotMainPort
    statusbox 'XDot already in debug mode!' msg1
    mpause 300
    closesbox
    closett
    end
endif
if result>1 goto REPROGRAM
if result=0 goto program_failed

:REPROGRAM
sprintf2 cmd2 'cmd /c copy C:\V-Projects\XDot-Controller\BIN-Files\xdot-firmware-3.0.2-US915-mbed-os-5.4.7-debug.bin %s' xdotDriveLoc
exec cmd2
sprintf2 msg1 'PORT %s PROGRAMMING' xdotMainPort
sprintf2 msg2 'Transfering bin file to %s...' xdotDriveLoc
statusbox msg2 msg1
mpause 18000
closesbox
disconnect
mpause 1500
sprintf2 cmd3 '/C=%s' xdotBreakPort
connect cmd3
flushrecv
setbaud 9600
mpause 3000
sendbreak
disconnect
mpause 500
sprintf2 cmd1 '/C=%s' xdotMainPort
connect cmd1
flushrecv
setbaud 115200
mpause 1000
sendln 'at'
wait 'OK'
if result=0 then
    fail=fail+1
    if fail < 3 then
        goto REPROGRAM
    endif
    :program_failed
    statusbox 'XDOT Failed to Program!' portNumberFailureMsg
	testStatus = 'FAILED TO PROGRAM'
	fail = 0
	goto WRITE_RESULT_DATA
endif
goto CHECK_CURRENT_PROGRAM

:WRITE_RESULT_DATA
mpause 300
sprintf2 msg1 '%s-XDOT RE-PROGRAM COMPLETE' xdotPortName
sprintf2 msg2 'PORT %s PASSED' xdotMainPort
statusbox msg1 msg2
end
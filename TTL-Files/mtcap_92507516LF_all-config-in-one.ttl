;
;	Author: 		Viet Ho
;	CANNOT STAND-ALONE RUN!!!!
;

show 0
isStep1 = -1
isStep2 = -1
isStep3 = -1
try = 1
errMsg = ""
step1SrcFile1 = 'C:\vbtest\MTCAP\MTCAP-LNA3-915-001A-MAR\config_MTCAP-LNA3-915-001A_1_7_4_09_24_19.tar.gz'
step1DesFile1 = '/tmp'
step2SrcFile1 = 'C:\vbtest\MTCAP\MTCAP-LNA3-915-001A-MAR\conduit-external-no-sdcard.tar.gz'
step2DesFile1 = '/home/root/conduit-external-no-sdcard.tar.gz'

whatStep = param2
strcompare whatStep 'STEP1'
isStep1 = result
strcompare whatStep 'STEP2'
isStep2 = result
strcompare whatStep 'STEP3'
isStep3 = result

isStep2 = 0
:CONNECTING
flushrecv
sprintf2 msg 'CONNECTING TO TERATERM...(%d)' try
statusbox msg 'TERATERM CONNECTION'
timeout = 25 ; connection timeout in seconds
mpause 1000
if isStep1=0 connect "192.168.2.1:22 /ssh /2 /auth=password /user=admin /passwd=admin /nosecuritywarning"
if isStep2 = 0 || isStep3 = 0 connect "192.168.2.1:22 /ssh /2 /auth=password /user=admin /passwd=Conduit$@20Password16 /nosecuritywarning"

if result < 2 then
    try=try +1
    if try < 6 goto CONNECTING
    messagebox 'FAILED TO CONNECT TO TERATERM' 'CONNECTION ERROR'
    end
endif
try = 1

if isStep1=0 goto STEP1
if isStep2=0 goto STEP2
if isStep3=0 goto STEP3

;;;;;;;;;;;;;;STEP 1
:STEP1
flushrecv
statusbox 'RUNNING STEP 1' 'STEP 1'
setsync 1
wait '#'
sendln 'microcom /dev/modem_at1'
mpause 500
sendln 'ate1'
wait "OK"
mpause 500
sendln 'at'
wait "OK"
mpause 500
sendln 'AT#GPIO=1,0,2'
wait 'OK'
mpause 500
sendln 'AT#SLED=2'
wait 'OK'
mpause 500
sendln 'AT#SLEDSAV'
wait 'OK'
mpause 1000

send 24
wait "#"
mpause 500

flushrecv
sprintf2 curlCmd 'curl -s -m 5 -X PUT -H "Content-Type: json/application" -d %s{"firstTimeSetup" : "false"}%s 127.0.0.1/api/system' #39 #39
sendln curlCmd
wait 'success'
if result = 0 then
   errMsg = 'COULD NOT DISABLE CH'
   goto step1_failed
endif
send 13
wait '#'

flushrecv
sprintf2 curlCmd 'curl -s -m 5 -X POST -H "Content-Type: json/application" -d %s{}%s 127.0.0.1/api/command/save' #39 #39
sendln curlCmd
wait 'success'
if result = 0 then
   errMsg = 'COULD NOT SAVE FIRST CONFIG'
   goto step1_failed
endif
send 13
wait '#'

flushrecv
scpsend step1SrcFile1 step1DesFile1
do
   statusbox 'TRANSFERING FILE 1/1...' 'STEP 1'
   mpause 10
   sprintf2 str 'ps -ef |grep -v grep |grep -c scp'
   sendln str
   waitln '0' '1'
loop while result != 1
mpause 1000
statusbox 'TRANSFER CONFIGURATION FILE COMPLETE!' 'STEP 1'
mpause 2000

flushrecv
statusbox 'IMPORTING CONFIGURATION' 'STEP 1'
sendln 'import_config /tmp/config_MTCAP-LNA3-915-001A_1_7_4_09_24_19.tar.gz'
wait '#'
statusbox 'SAVING OEM' 'STEP 1'
mpause 500
sendln 'save_oem'
wait 'Watchdog'
mpause 500
statusbox 'STEP 1 IS FINISHED' 'STEP 1 DONE'
mpause 1500
sendln 'reboot'
mpause 2000
closett
end

;;;goto STEP2
:step1_failed
closesbox
statusbox errMsg 'STEP 1 FAILED'
mpause 400
disconnect
closett
end

;;;;;;;;;;;;;;STEP 2
:STEP2
flushrecv
statusbox 'RUNNING STEP 2' 'STEP 2'
setsync 1

mpause 1000
flushrecv
scpsend step2SrcFile1 step2DesFile1
do
   statusbox 'TRANSFERING FILE 1/1...' 'STEP 2'
   mpause 10
   sprintf2 str 'ps -ef |grep -v grep |grep -c scp'
   sendln str
   waitln '0' '1'
loop while result != 1
mpause 1000
statusbox 'TRANSFER CONFIGURATION FILE COMPLETE!' 'STEP 2'
mpause 2000

;;;;;;;;;
:step2_failed
closesbox
statusbox errMsg 'STEP 2 FAILED'
mpause 400
disconnect
closett
end

; 
; File: mtac-mfser-tst.ttl
; Description: Teraterm Script For Functional Test of MTAC-MFSER's
; Environment: generic
; Update: 04/10/2014
; Author: Rick Geier

timeout = 55
imeistr = ''
barcode = ''
serial1 = ''
serial2 = ''
clearscreen 1
fail=0

;logopen 'C:\MTCBA2 log files\set_mtcba2_env_ss_blank.log' 0 0 0 0 1
;connect '192.168.2.1 /ssh /auth=password /user=root /passwd=limerock'
sendln 'mtadm'
wait 'word:'
mpause 1000
sendln 'root'
wait '$'
mpause 500
sendln 'sudo -s'
wait 'word:'
mpause 500
sendln 'root'
wait "#"
pause 1

:START
serial1 = ''
serial2 = ''
send 13
wait '#'
flushrecv
sendln '/etc/init.d/./mts-io stop'
pause 5
sendln '/etc/init.d/./mts-io start'
pause 5
mpause 500
flushrecv
:SERIAL_SCAN1
inputbox 'Enter Serial AP1 #' 'Get Serial #-AP1'
strlen inputstr
if result<>8 then
      messagebox 'Invalid Serial Number. Please scan again' 'SERIAL # SCAN'
      goto SERIAL_SCAN1
    endif
strconcat serial1 inputstr
send './set-eeprom-mtac-mfser.sh 1 MTAC-MFSER-DCE '
sendln inputstr
wait "#"
mpause 1000
flushrecv
:SERIAL_SCAN2
inputbox 'Enter Serial AP2 #' 'Get Serial #-AP2'
strlen inputstr
if result<>8 then
      messagebox 'Invalid Serial Number. Please scan again' 'SERIAL # SCAN'
      goto SERIAL_SCAN2
    endif
strconcat serial2 inputstr
send './set-eeprom-mtac-mfser.sh 2 MTAC-MFSER-DCE '
sendln inputstr
wait "#"
mpause 3
flushrecv
sendln '/etc/init.d/./mts-io stop'
pause 5
sendln '/etc/init.d/./mts-io start'
pause 5
/*
sendln 'reboot'
wait "login:"
mpause 1000
sendln 'root'
wait "word:"
mpause 1000
sendln 'root'
wait "#"
*/
send 13
wait '#'

flushrecv
timeout = 10
mpause 1000
sendln 'mts-io-sysfs store mfser/serial-mode rs232'
wait "#"
mpause 1000
sendln 'microcom -d 5 -s 921600 /dev/ttyAP1'
mpause 2000
flushrecv
:RETRY1
flushrecv
send 'The quick brown fox jumps over the lazy dog!'
wait "The quick brown fox jumps over the lazy dog!"
if result=1 then
  mpause 500
else
    fail=fail+1
    if fail < 3 then
      goto RETRY1
    endif
  beep
  
 messagebox "PORT 1 DATA FAILURE" "PORT STATUS
  end
  disconnect
endif
mpause 1000
send 24
sendln
messagebox "prepare to check port 1 led's" "PORT STATUS
sendln 'microcom -d 5 -s 2400 /dev/ttyAP1'
mpause 2000
flushrecv
send 'The quick brown fox jumps over the lazy dog!'
mpause 2000
send 10
send 13
mpause 1000
send 24
sendln
;messagebox "Ready to test AP2" "Status"
pause 2
flushrecv
sendln 'mts-io-sysfs store mfser-2/serial-mode rs232'
wait "#"
mpause 1000
sendln 'microcom -d 5 -s 921600 /dev/ttyAP2'
mpause 2000
flushrecv
sendln'The quick brown fox jumps over the lazy dog!'
mpause 700
flushrecv
:RETRY2
flushrecv
sendln 'The quick brown fox jumps over the lazy dog!'
wait "The quick brown fox jumps over the lazy dog!"
if result=1 then
  mpause 500
else
    fail=fail+1
    if fail < 3 then
      goto RETRY2
    endif
  beep  
 messagebox "PORT 2 DATA FAILURE" "PORT STATUS
  end
  disconnect
endif
send 24
wait "#"
sendln
messagebox "prepare to check port 2 led's" "PORT STATUS
sendln 'microcom -d 5 -s 2400 /dev/ttyAP2'
mpause 2000
flushrecv
send 'The quick brown fox jumps over the lazy dog!'
send 10
send 13
mpause 1000
send 24
sendln
mpause 1000

flushrecv
flushrecv
mpause 500
sendln 'mts-io-sysfs show ap1/device-id'
waitln serial1
if result=1 then
  mpause 1000
else
  beep
  messagebox "MTAC AP1 SERIAL # MISMATCH --- PLEASE RETEST" "PORT STATUS"
  end
  disconnect
endif
mpause 500
flushrecv
flushrecv
mpause 500
sendln 'mts-io-sysfs show ap2/device-id'
waitln serial2
if result=1 then
  mpause 1000
else
  beep
  messagebox "MTAC AP2 SERIAL # MISMATCH --- PLEASE RETEST" "PORT STATUS"
  end
  disconnect
endif
;messagebox "MTAC-MFSER Test Complete" "Status"
/*
sendln 'halt'
wait "reboot: Power down"
mpause 1000
*/
messagebox "MTAC-MFSER -AP1 & AP2 Test Complete" "Status"
 pause 1
sendln '/etc/init.d/./mts-io stop'
pause 1
messagebox 'Remove MTAC_MFSER cards' 'TEST COMPLETE'
yesnobox 'Do you want to test another device?' ' MTAC-MFSER TEST'
if result=1 then 
pause 1
goto START
endif
if result=0 goto END


;disconnect
;logclose
end
:END
disconnect
closett
end